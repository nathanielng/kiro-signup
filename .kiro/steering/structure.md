# Project Structure

## Root Directory
```
.
├── backend-template.yaml      # Backend CloudFormation template (~1000 lines)
├── frontend-template.yaml     # Frontend CloudFormation template
├── deploy-backend.sh          # Backend deployment script with auto-detection
├── deploy-frontend.sh         # Frontend deployment script
├── upload-frontend.sh         # Upload frontend files to S3
├── update-bedrock-prompt.sh   # Update Bedrock prompt in Parameter Store
├── test_api.py                # API testing script (auto-retrieves credentials)
├── check_stack.py             # Stack verification script
├── check_credits.py           # Credit checking script
├── test_check_credits.py      # Test script for credit checking
├── frontend/                  # Web frontend files
├── README.md                  # Main documentation
├── ARCHITECTURE.md            # Complete architecture documentation
├── DEPLOYMENT_GUIDE.md        # Deployment reference guide
└── archive/                   # Historical documentation
```

## Frontend Directory
```
frontend/
├── index.html                 # Main HTML page
├── styles.css                 # CSS styles (vanilla CSS with CSS variables)
├── app.js                     # Frontend JavaScript logic (vanilla JS)
└── config.js                  # API configuration (auto-generated by upload script)
```

## CloudFormation Templates

### backend-template.yaml
Contains inline Lambda code for:
- **UserManagementFunction**: Creates users and manages group membership
- **CheckCreditsFunction**: Analyzes screenshots and triggers user creation

Also defines:
- IAM roles with least privilege permissions
- API Gateway REST API with two endpoints
- API key and usage plan
- S3 bucket for screenshots
- Parameter Store entries

### frontend-template.yaml
Defines:
- CloudFront distribution with OAC
- S3 bucket policy for CloudFront access
- Custom error responses (403/404 → index.html)
- DefaultRootObject configuration
- Parameter Store for API endpoint

## Deployment Scripts

### deploy-backend.sh
- Auto-detects or creates IAM Identity Center instance
- Generates secure API keys if not provided
- Checks for existing stacks and handles failed states
- Supports force update mode (-f flag)
- Stores API key in Parameter Store

### deploy-frontend.sh
- Retrieves backend parameters automatically
- Creates or updates CloudFront distribution
- Configures S3 bucket with OAC
- Supports force update mode

### upload-frontend.sh
- Generates config.js with API endpoint
- Uploads HTML, CSS, JS files to S3
- Invalidates CloudFront cache
- Waits for invalidation completion

## API Endpoints

### POST /create-user
Admin endpoint for direct user creation.

**Request:**
```json
{
  "name": "John Doe",
  "email": "john@example.com",
  "firstName": "John",
  "lastName": "Doe"
}
```

### POST /check-credits
Primary user flow for credit verification and auto-upgrade.

**Request:**
```json
{
  "image": "<base64-encoded-png>",
  "email": "user@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "image_name": "screenshot.png"
}
```

## Parameter Store Paths
- `/kiro/kiro-user-management-api/api-key` - API key (reference only)
- `/kiro/kiro-user-management-api/bedrock-prompt` - Bedrock system prompt
- `/kiro/kiro-user-management-api/kiro-pro-group-id` - Kiro Pro group ID
- `/kiro/kiro-user-management-frontend/api-endpoint` - API endpoint URL

## S3 Structure
```
kiro-user-management-api-screenshots-{account-id}/
├── screenshots/
│   ├── {timestamp}-{email}.png           # Depleted credits (approved)
│   └── {timestamp}-{email}-deny.png      # Credits available (denied)
└── frontend/                              # Frontend files (if using same bucket)
    ├── index.html
    ├── styles.css
    ├── app.js
    └── config.js
```

## Lambda Function Structure

### UserManagementFunction
- `lambda_handler()` - Main entry point
- `get_identity_store_id()` - Extract identity store from instance
- `create_identity_center_user()` - Create user in Identity Center
- `find_user_by_email()` - Check for duplicate users
- `get_kiro_pro_group_id()` - Get or create Kiro Pro group
- `add_user_to_group()` - Add user to group
- `create_response()` - Format HTTP response

### CheckCreditsFunction
- `lambda_handler()` - Main entry point
- `check_user_kiro_pro_status()` - Check if user exists and has Kiro Pro
- `add_user_to_kiro_pro()` - Invoke UserManagementFunction
- `check_credits_used_up()` - Analyze screenshot with Bedrock
- `save_screenshot_to_s3()` - Store screenshot for audit
- `create_response()` - Format HTTP response

## Frontend Structure

### index.html
- API configuration card (user enters API key)
- Credit check form with file upload
- Image preview
- Result display area

### app.js
- API key management (session storage)
- File upload and preview
- Form submission and validation
- Error handling with specific messages
- Base64 encoding for images

### styles.css
- CSS variables for theming
- Responsive design (mobile-friendly)
- Card-based layout
- Animation for result display

## Naming Conventions
- **Stack Names**: kebab-case (kiro-user-management-api)
- **Lambda Functions**: PascalCase (UserManagementFunction)
- **Parameters**: camelCase (IdentityCenterInstanceArn)
- **Environment Variables**: SCREAMING_SNAKE_CASE (IDENTITY_CENTER_INSTANCE_ARN)
- **S3 Keys**: kebab-case with timestamps (screenshots/{timestamp}-{email}.png)

## Important Constraints
- Only one IAM Identity Center instance per region
- API keys are immutable (require stack deletion to change)
- Lambda code is inline in CloudFormation (no separate files)
- Frontend uses vanilla JavaScript (no build process)
- S3 bucket names must be globally unique
